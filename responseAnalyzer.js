import 'dotenv/config';
import OpenAI from 'openai';
import { getOpenAIConfig } from './proxyConfig.js';

// –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π OpenAI –∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤
const openaiClient = new OpenAI(getOpenAIConfig(process.env.OPENAI_API_KEY));

// –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
export async function analyzeResponse(responseText) {
    try {
        const completion = await openaiClient.chat.completions.create({
            model: "gpt-4o",
            messages: [
                {
                    role: "system",
                    content: `–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤. 

                    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º (—Å–æ–≥–ª–∞—Å–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º (–æ—Ç–∫–∞–∑, –Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ).

                    –í–ê–ñ–ù–û:
                    - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–ø—Ä–∏–≤–µ—Ç, –¥–æ–±—Ä—ã–π –¥–µ–Ω—å, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ –∏ —Ç.–¥.) –ù–ï —è–≤–ª—è—é—Ç—Å—è –Ω–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏, –Ω–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ - —ç—Ç–æ –ù–ï–ô–¢–†–ê–õ–¨–ù–û
                    - –°–ª–æ–≤–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ (—Å–ø–∞—Å–∏–±–æ, –±–ª–∞–≥–æ–¥–∞—Ä—é) - —ç—Ç–æ –ù–ï–ô–¢–†–ê–õ–¨–ù–û
                    - –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å–º—ã—Å–ª–∞ (—Ö–æ—Ä–æ—à–æ, –æ–∫, –ø–æ–Ω—è–ª) –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ - —ç—Ç–æ –ù–ï–ô–¢–†–ê–õ–¨–ù–û

                    –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –æ—Ç–≤–µ—Ç—ã: –¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω, –≤–µ—Ä–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —Ç–∞–∫ –∏ –µ—Å—Ç—å, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∫–æ–Ω–µ—á–Ω–æ, –±–µ–∑—É—Å–ª–æ–≤–Ω–æ, –∞–≥–∞, —É–≥—É, +, –ø—Ä–∏—Å—Ç—É–ø–∞–π, –¥–∞–≤–∞–π, –ø–æ–µ—Ö–∞–ª–∏
                    –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ï –æ—Ç–≤–µ—Ç—ã: –Ω–µ—Ç, –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω, –Ω–µ–≤–µ—Ä–Ω–æ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–µ —Ç–∞–∫, –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å, –æ—Ç–∫–∞–∑, –Ω–µ –Ω—É–∂–Ω–æ, –Ω–µ –Ω–∞–¥–æ, -, –Ω–µ —Å–¥–∞—é

                    –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
                    - 'true' –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô
                    - 'false' –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô  
                    - 'neutral' –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞

                    –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`
                },
                {
                    role: "user",
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ–Ω, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π:\n\n"${responseText}"`
                }
            ],
            temperature: 0.2,
            max_tokens: 10
        });

        const result = completion.choices[0]?.message.content?.trim().toLowerCase();
        
        if (result === 'neutral' || result?.includes('neutral') || result?.includes('–Ω–µ–π—Ç—Ä–∞–ª')) {
            return null;
        }
        
        if (result === 'true' || result === 'false') {
            return result === 'true';
        }
        
        const hasTrue = result?.includes('true') || result?.includes('–¥–∞') || result?.includes('–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π');
        const hasFalse = result?.includes('false') || result?.includes('–Ω–µ—Ç') || result?.includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π');
        
        if (hasTrue && !hasFalse) return true;
        if (hasFalse && !hasTrue) return false;
        
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º, –µ—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ
        return null;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ GPT:', error.message);
        if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {
            console.error('üîå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–∫—Å–∏ (USE_PROXY=false)');
        }
        return null;
    }
}

