import 'dotenv/config';
import OpenAI from 'openai';
import { getOpenAIConfig } from './proxyConfig.js';

// –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π OpenAI –∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤
const openaiClient = new OpenAI(getOpenAIConfig(process.env.OPENAI_API_KEY));

// –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
export async function analyzeResponse(responseText) {
    try {
        const completion = await openaiClient.chat.completions.create({
            model: "gpt-4o",
            messages: [
                {
                    role: "system",
                    content: `
                    –¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –±–∏–∑–Ω–µ—Å-–¥–∏–∞–ª–æ–≥–µ. 

                    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º (—Å–æ–≥–ª–∞—Å–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º (–æ—Ç–∫–∞–∑, –Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ).

                    –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ –≤ –±–∏–∑–Ω–µ—Å-–¥–∏–∞–ª–æ–≥–µ, —ç—Ç–æ –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ.

                    –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –æ—Ç–≤–µ—Ç—ã (—Å–æ–≥–ª–∞—Å–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ):
                    - –Ø–≤–Ω—ã–µ: –¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω, –≤–µ—Ä–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —Ç–∞–∫ –∏ –µ—Å—Ç—å, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∫–æ–Ω–µ—á–Ω–æ, –±–µ–∑—É—Å–ª–æ–≤–Ω–æ, –∞–≥–∞, —É–≥—É, +
                    - –ö–æ—Ä–æ—Ç–∫–∏–µ: —Ö–æ—Ä–æ—à–æ, –æ–∫, –æ–∫–µ–π, –ø–æ–Ω—è–ª, –ª–∞–¥–Ω–æ, –¥–∞–≤–∞–π, –ø–æ–µ—Ö–∞–ª–∏, –ø—Ä–∏—Å—Ç—É–ø–∞–π, –≥–æ–¥–∏—Ç—Å—è
                    - –§—Ä–∞–∑—ã: –≤—Å–µ –≤–µ—Ä–Ω–æ, –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤—Å–µ —Ç–∞–∫, –≤—Å–µ –æ–∫–µ–π, –≤—Å–µ –æ–∫, –º–æ–∂–Ω–æ
                    
                    –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ï –æ—Ç–≤–µ—Ç—ã (–æ—Ç–∫–∞–∑, –Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ):
                    - –Ø–≤–Ω—ã–µ: –Ω–µ—Ç, –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω, –Ω–µ–≤–µ—Ä–Ω–æ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–µ —Ç–∞–∫, –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å, –æ—Ç–∫–∞–∑, -, –Ω–µ —Å–¥–∞—é
                    - –§—Ä–∞–∑—ã: –Ω–µ –Ω—É–∂–Ω–æ, –Ω–µ –Ω–∞–¥–æ, –Ω–µ —Ö–æ—á—É, –Ω–µ –±—É–¥—É, –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –ø–µ—Ä–µ–¥—É–º–∞–ª
                    
                    –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ï (—Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Å–ª—É—á–∞–∏):
                    - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å: –ø—Ä–∏–≤–µ—Ç, –¥–æ–±—Ä—ã–π –¥–µ–Ω—å, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ (–ë–ï–ó "–¥–∞" –∏–ª–∏ "–Ω–µ—Ç")
                    - –¢–æ–ª—å–∫–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏: —Å–ø–∞—Å–∏–±–æ, –±–ª–∞–≥–æ–¥–∞—Ä—é (–ë–ï–ó —Å–æ–≥–ª–∞—Å–∏—è/–æ—Ç–∫–∞–∑–∞)
                    - –í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞: —á—Ç–æ? –∫–æ–≥–¥–∞? –ø–æ—á–µ–º—É? —Å–∫–æ–ª—å–∫–æ?

                    –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
                    - 'true' –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô
                    - 'false' –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô  
                    - 'neutral' –µ—Å–ª–∏ —ç—Ç–æ –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏–ª–∏ –≤–æ–ø—Ä–æ—Å

                    –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`
                },
                {
                    role: "user",
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ–Ω, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π:\n\n"${responseText}"`
                }
            ],
            temperature: 0.2,
            max_tokens: 10
        });

        const result = completion.choices[0]?.message.content?.trim().toLowerCase();
        
        if (result === 'neutral' || result?.includes('neutral') || result?.includes('–Ω–µ–π—Ç—Ä–∞–ª')) {
            return null;
        }
        
        if (result === 'true' || result === 'false') {
            return result === 'true';
        }
        
        const hasTrue = result?.includes('true') || result?.includes('–¥–∞') || result?.includes('–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π');
        const hasFalse = result?.includes('false') || result?.includes('–Ω–µ—Ç') || result?.includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π');
        
        if (hasTrue && !hasFalse) return true;
        if (hasFalse && !hasTrue) return false;
        
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º, –µ—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ
        return null;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ GPT:', error.message);
        if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {
            console.error('üîå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–∫—Å–∏ (USE_PROXY=false)');
        }
        return null;
    }
}

