import 'dotenv/config';
import OpenAI from 'openai';
import { getOpenAIConfig } from './proxyConfig.js';

const openai = new OpenAI(getOpenAIConfig(process.env.OPENAI_API_KEY));

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º
 * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
 * @returns {Promise<boolean>} - true –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ
 */
export async function isObjection(message) {
    try {
        const completion = await openai.chat.completions.create({
            model: "gpt-4o",
            messages: [
                {
                    role: "system",
                    content: `–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞—Ä–µ–Ω–¥—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.
                    
                    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –í–û–ó–†–ê–ñ–ï–ù–ò–ï–ú.
                    
                    –í–û–ó–†–ê–ñ–ï–ù–ò–Ø - —ç—Ç–æ:
                    - –°–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–µ (–¥–æ—Ä–æ–≥–æ, –º–Ω–æ–≥–æ, –Ω–µ –ø–æ –∫–∞—Ä–º–∞–Ω—É, –ø–æ—á–µ–º—É —Ç–∞–∫ –¥–æ—Ä–æ–≥–æ)
                    - –°–æ–º–Ω–µ–Ω–∏—è –æ –∫–æ–º–∏—Å—Å–∏–∏ (–±–æ–ª—å—à–∞—è –∫–æ–º–∏—Å—Å–∏—è, –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç, –º–Ω–æ–≥–æ –±–µ—Ä—ë—Ç–µ)
                    - –í–æ–ø—Ä–æ—Å—ã –æ –∫–∞—á–µ—Å—Ç–≤–µ —É—Å–ª—É–≥ (–∞ –∑–∞—á–µ–º –º–Ω–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ, —è —Å–∞–º –Ω–∞–π–¥—É, —Å–ø—Ä–∞–≤–ª—é—Å—å —Å–∞–º)
                    - –°—Ä–æ—á–Ω–æ—Å—Ç—å/—Å—Ä–æ–∫–∏ (–Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ, —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ, –∫–æ–≥–¥–∞ —Å–¥–∞–¥–∏—Ç–µ)
                    - –£—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞—é—Ç —É—Å–ª–æ–≤–∏—è, —Ö–æ—á—É –∏–∑–º–µ–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä)
                    - –°—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ (—É –¥—Ä—É–≥–∏—Ö –¥–µ—à–µ–≤–ª–µ, —Ç–∞–º –ª—É—á—à–µ —É—Å–ª–æ–≤–∏—è)
                    - –ù–µ–¥–æ–≤–µ—Ä–∏–µ (–∞ –≤—ã —Ç–æ—á–Ω–æ —Å–¥–∞–¥–∏—Ç–µ, –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Ä–∞–Ω—å—à–µ)
                    - –ú—è–≥–∫–∏–π –æ—Ç–∫–∞–∑ —Å —Å–æ–º–Ω–µ–Ω–∏–µ–º (–Ω–µ —É–≤–µ—Ä–µ–Ω, –ø–æ–¥—É–º–∞—é, –Ω–µ –∑–Ω–∞—é, –º–æ–∂–µ—Ç –ø–æ—Ç–æ–º)
                    - –û—Ç–∫–∞–∑ —Å –ø—Ä–∏—á–∏–Ω–æ–π –∏–ª–∏ —Å–æ–º–Ω–µ–Ω–∏–µ–º (–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, —É–∂–µ –Ω–∞—à—ë–ª –¥—Ä—É–≥–∏—Ö, —É –º–µ–Ω—è –µ—Å—Ç—å –∞–≥–µ–Ω—Ç)
                    - –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—é
                    
                    –ù–ï –í–û–ó–†–ê–ñ–ï–ù–ò–Ø - —ç—Ç–æ:
                    - –ü—Ä–æ—Å—Ç—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–∫–∞–∫–æ–π –∞–¥—Ä–µ—Å, –∫–æ–≥–¥–∞ —Å–æ–∑–≤–æ–Ω–∏–º—Å—è, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç)
                    - –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ (–¥–∞, —Ö–æ—Ä–æ—à–æ, —Å–æ–≥–ª–∞—Å–µ–Ω, –¥–∞–≤–∞–π—Ç–µ, –ø–æ–¥—Ö–æ–¥–∏—Ç)
                    - –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞–∑ –ë–ï–ó –æ–±—ä—è—Å–Ω–µ–Ω–∏–π (–ø—Ä–æ—Å—Ç–æ "–Ω–µ—Ç" –∏ –≤—Å—ë, "–Ω–µ –±—É–¥—É", "—É–¥–∞–ª–∏—Ç–µ –Ω–æ–º–µ—Ä")
                    - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    
                    –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞ –∏–ª–∏ –≤—ã—Ä–∞–∂–∞–µ—Ç —Å–æ–º–Ω–µ–Ω–∏–µ - —ç—Ç–æ –í–û–ó–†–ê–ñ–ï–ù–ò–ï!
                    
                    –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û 'true' –∏–ª–∏ 'false':
                    - 'true' –µ—Å–ª–∏ —ç—Ç–æ –í–û–ó–†–ê–ñ–ï–ù–ò–ï (–º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º, –µ—Å—Ç—å —á—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
                    - 'false' –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –í–û–ó–†–ê–ñ–ï–ù–ò–ï (–ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞–∑)`
                },
                {
                    role: "user",
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n\n"${message}"\n\n–≠—Ç–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ?`
                }
            ],
            temperature: 0.3,
            max_tokens: 10
        });

        const result = completion.choices[0]?.message.content?.trim().toLowerCase();
        return result === 'true' || result?.includes('true');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è:', error.message);
        if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {
            console.error('üîå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–∫—Å–∏ (USE_PROXY=false)');
        }
        return false;
    }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ RAG (File Search)
 * @param {string} objection - –¢–µ–∫—Å—Ç –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
 * @param {string} vectorStoreId - ID Vector Store —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
 * @returns {Promise<string>} - –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ
 */
export async function handleObjection(objection, vectorStoreId) {
    try {
        console.log(`üîç –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: "${objection.substring(0, 50)}..."`);
        
        // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º File Search
        const assistant = await openai.beta.assistants.create({
            name: "–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π",
            instructions: `–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏ Capital Mars.
            
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
            
            –ü–†–ê–í–ò–õ–ê:
            1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –º–∞–∫—Å–∏–º—É–º 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            2. –ò—Å–ø–æ–ª—å–∑—É–π —É–≤–µ—Ä–µ–Ω–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω
            3. –ù–µ –∏–∑–≤–∏–Ω—è–π—Å—è –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã
            4. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
            5. –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –±–ª–∏–∑–∫–∏–π –ø–æ —Å–º—ã—Å–ª—É
            6. –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
            7. –û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä
            8. –ù–µ –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–°–æ–≥–ª–∞—Å–Ω–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π..." –∏–ª–∏ "–í –¥–æ–∫—É–º–µ–Ω—Ç–µ —É–∫–∞–∑–∞–Ω–æ..."
            9. –î–∞–π –≥–æ—Ç–æ–≤—É—é —Ä–µ–ø–ª–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É, –ë–ï–ó –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫, –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥
            10. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ "–Ω–∞–ø—Ä–∏–º–µ—Ä", "–º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å", "–º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å", "—Å—Ç–æ–∏—Ç", "—Å–ª–µ–¥—É–µ—Ç"
            
            –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –ü—Ä—è–º–æ–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π.`,
            model: "gpt-4o",
            tools: [{ type: "file_search" }],
            tool_resources: {
                file_search: {
                    vector_store_ids: [vectorStoreId]
                }
            },
            temperature: 0.7,
            top_p: 1.0
        });

        // –°–æ–∑–¥–∞—ë–º —Ç—Ä–µ–¥ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
        const thread = await openai.beta.threads.create({
            messages: [
                {
                    role: "user",
                    content: `–ö–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç: "${objection}"\n\n–ö–∞–∫ –º–Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ?`
                }
            ]
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å service_tier: flex
        const run = await openai.beta.threads.runs.create(thread.id, {
            assistant_id: assistant.id,
            truncation_strategy: {
                type: "auto"
            },
            temperature: 0.7,
            top_p: 1.0,
            max_prompt_tokens: 10000,
            max_completion_tokens: 500
        });

        // –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        const completedRun = await waitForRunCompletion(thread.id, run.id);

        // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
        const messages = await openai.beta.threads.messages.list(thread.id);
        const assistantMessage = messages.data.find(msg => msg.role === 'assistant');
        
        if (!assistantMessage) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞');
        }

        const response = assistantMessage.content[0].text.value;

        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
        await openai.beta.assistants.del(assistant.id);

        console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: "${response.substring(0, 50)}..."`);
        
        return formatResponseForWhatsApp(response);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è:', error.message);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        return '–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —Å–æ–º–Ω–µ–Ω–∏—è. –î–∞–≤–∞–π—Ç–µ —è —Å–≤—è–∂—É –≤–∞—Å —Å –Ω–∞—à–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.';
    }
}

/**
 * –û–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Run –≤ Thread
 * @param {string} threadId - ID —Ç—Ä–µ–¥–∞
 * @param {string} runId - ID –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 * @returns {Promise<Object>} - –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π Run
 */
async function waitForRunCompletion(threadId, runId) {
    let attempts = 0;
    const maxAttempts = 60; // –ú–∞–∫—Å–∏–º—É–º 60 –ø–æ–ø—ã—Ç–æ–∫ (2 –º–∏–Ω—É—Ç—ã)
    
    while (attempts < maxAttempts) {
        try {
            const run = await openai.beta.threads.runs.retrieve(threadId, runId);
            
            if (run.status === 'completed') {
                return run;
            }
            
            if (run.status === 'failed' || run.status === 'cancelled' || run.status === 'expired') {
                throw new Error(`Run –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º: ${run.status}`);
            }
            
            // –û–∂–∏–¥–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            await new Promise(resolve => setTimeout(resolve, 2000));
            attempts++;
            
        } catch (error) {
            if (error.message.includes('Run –∑–∞–≤–µ—Ä—à–∏–ª—Å—è')) {
                throw error;
            }
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ Run:', error.message);
            throw error;
        }
    }
    
    throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Run');
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ WhatsApp
 * @param {string} response - –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç GPT
 * @returns {string} - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
 */
export function formatResponseForWhatsApp(response) {
    // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    let formatted = response.trim();
    
    // –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ –¥–≤–æ–π–Ω—ã–µ
    formatted = formatted.replace(/\n{3,}/g, '\n\n');
    
    // –£–¥–∞–ª—è–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    formatted = formatted.replace(/\*\*/g, '');
    formatted = formatted.replace(/\*/g, '');
    formatted = formatted.replace(/#{1,6}\s/g, '');
    
    // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∞-—Å–ª–æ–≤–µ—á–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
    const metaPhrases = [
        /^–∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç[^\.!?]*[\.!?]\s*/i,
        /^–ø–æ–Ω–∏–º–∞—é,? —á—Ç–æ[^\.!?]*[\.!?]\s*/i,
        /\b–Ω–∞–ø—Ä–∏–º–µ—Ä[,\s]+/gi,
        /\b–º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å[,\s]+/gi,
        /\b–º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å[,\s]+/gi,
        /\b—Å—Ç–æ–∏—Ç\s+[^\.!?]*[,\.]\s*/gi,
        /\b—Å–ª–µ–¥—É–µ—Ç\s+[^\.!?]*[,\.]\s*/gi
    ];
    for (const re of metaPhrases) {
        formatted = formatted.replace(re, '');
    }
    
    // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ –±–æ–ª–µ–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    const sentences = formatted.split(/(?<=[\.!?])\s+/).filter(Boolean);
    formatted = sentences.slice(0, 2).join(' ');
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ (–¥–ª—è WhatsApp)
    if (formatted.length > 500) {
        formatted = formatted.substring(0, 497) + '...';
    }
    
    return formatted;
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
 * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
 * @param {string} vectorStoreId - ID Vector Store
 * @returns {Promise<string|null>} - –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ null –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ
 */
export async function processMessage(message, vectorStoreId) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º
        const isObjectionMessage = await isObjection(message);
        
        if (!isObjectionMessage) {
            console.log(`‚ÑπÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º: "${message.substring(0, 50)}..."`);
            return null;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ RAG
        console.log(`üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: "${message.substring(0, 50)}..."`);
        const response = await handleObjection(message, vectorStoreId);
        
        return response;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error.message);
        return null;
    }
}

